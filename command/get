#!/usr/bin/env bash

get_command() {
  begin_function

    local cell_path=${cell_path:-}
    if [[ "${member:-}" ]]; then
      local sane_value
      get_sane_value "$member" || fail
      cell_path=$parent_cell/$dim:$sane_value
    fi

    switch_context || fail
    if [[ $cell_is_leaf == t ]]; then

      if [[ -d $out_path/auto ]]; then
        load_vars $out_path/auto || fail
      fi

      if function_exists get_op; then
        execute_op get || fail
      else

        local get_show_file=${get_show_file:-}

        if [[ "$get_show_file" && -f "$out_path/$get_show_file" ]]; then
          cat $out_path/$get_show_file || fail
        else
          if is_array data; then
            if [[ -v data_fields ]]; then
              out "${data_fields[*]}"
            fi
            begin_for row in "${data[@]}"; doo
              out "$row"
            end_for
          elif [[ -v data ]]; then
            out "$data"
          else
            out "No data"
          fi
        fi

      fi
    else
      par=f fork=f \
      function=get_command \
      parent_cell=$cell_path \
      for_each_member $leaf_dims || fail
    fi

    command_successful=t

  end_function
  handle_return
}

